@page "/new-game"
@using System.Collections.Generic
@using System.Linq
@using System.Threading.Tasks
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.SignalR.Client
@using Microsoft.Extensions.Logging
@using Stop.Shared
@inject NavigationManager NavigationManager
@implements System.IDisposable
@inject Blazored.LocalStorage.ILocalStorageService localStore


@if (CurrentGame == null)
{
    <h1>Create new game</h1>

    <input type="text" class="editable" @bind="Topic"/>
    <button class="btn btn-primary" @onclick="AddTopic">Add</button>

    <ul>
        @foreach (var topic in Topics)
        {
            <li>@topic - <button @onclick="@((e) => RemoveTopic(topic))">Remove</button></li>
        }
    </ul>

    <button class="btn btn-primary" @onclick="StartGame">Create game</button>
}
else if (CurrentGame.Rounds.Count == 0)
{
    var link = NavigationManager.ToAbsoluteUri($"/game/{CurrentGame.Id}?password={CurrentGame.Password}");
    
    <h1>Waiting for players to join</h1>
    <p><span>Url: @CurrentGame.Id</span><br>
        <span>Password: @CurrentGame.Password</span></p>
    <p>Link: <a href="@link">@link</a></p>
     
    <ul>
    @foreach (var player in CurrentGame.Players)
    {
        <li>@player.Name</li>
    }
    </ul>
                                      
    <button class="btn btn-primary" @onclick="StartRound" disabled="@DisableStartButton">Start round</button>
    <button class="btn btn-danger" @onclick="DeleteGame">Delete game</button>
}
else if (CurrentGame.Rounds.Last().Finished == false)
{
    <h1>Current Letter: <b>@CurrentGame.Rounds.Last().Letter</b></h1>
    <label>Players:</label>
    <ul>
        @foreach (var player in CurrentGame.Players)
        {
            <li>@player.Name</li>
        }
    </ul>
    <button class="btn btn-danger" @onclick="DeleteGame">Delete game</button>
}
else
{
    <table>
        <thead>
        <th>Player</th>
        @foreach (var topic in CurrentGame.Topics)
        {
            <th>@topic</th>
        }
        <th>score</th>
        </thead>
        <tbody>
        @foreach (var answers in CurrentGame.Rounds.Last().Answers)
        {
            <tr>
                <td>@answers.Key</td>
                @foreach (var answer in answers.Value)
                {
                    <td>
                        @answer
                        <input type="checkbox"/>
                    </td>
                }
                @* <td>@roundPlayer.Value.Score</td> *@
            </tr>
        }
        </tbody>
    </table>
    
    
    <button class="btn btn-primary" @onclick="StartRound">Start round</button>
    <button class="btn btn-danger" @onclick="DeleteGame">Delete game</button>
}

@code {
    private HubConnection hubConnection;
    public string Topic { get; set; }
    public Stop.Shared.Game CurrentGame { get; set; }
    public List<string> Topics { get; set; }

    protected override async Task OnInitializedAsync()
    {
        Topics = new List<string>();

        hubConnection = new HubConnectionBuilder().WithUrl(NavigationManager.ToAbsoluteUri("/websocket")).Build();
        hubConnection.On<Stop.Shared.Game>("GameStarted", async (game) =>
        {
            CurrentGame = game;
            await localStore.SetItemAsync<string>("game_id", CurrentGame.Id);
            await localStore.SetItemAsync<string>("game_password", CurrentGame.Password);
            StateHasChanged();
        });
        hubConnection.On<Stop.Shared.Game>("GameLoaded", (game) =>
        {
            CurrentGame = game;
            StateHasChanged();
        });
        hubConnection.On<Stop.Shared.Game>("RoundStarted", (game) =>
        {
            CurrentGame = game;
            StateHasChanged();
        });
        hubConnection.On<Stop.Shared.Round>("RoundEnded", (round) =>
        {
            Console.WriteLine("RoundEnded");
            // CurrentGame = game;
            // Console.WriteLine($"Round finished: {game.Rounds.Last().Letter}");
            StateHasChanged();
        });
        hubConnection.On<Stop.Shared.Game>("JoinedGame", (game) =>
        {
            CurrentGame = game;
            StateHasChanged();
        });
        hubConnection.On<Stop.Shared.Game>("GameDeleted", async (x) =>
        {
            CurrentGame = null;
            await localStore.RemoveItemAsync("game_id");
            await localStore.RemoveItemAsync("game_password");
            StateHasChanged();
        });

        await hubConnection.StartAsync();
        
        
        var gameId = await localStore.GetItemAsync<string>("game_id");
        var password = await localStore.GetItemAsync<string>("game_password");
        if(!string.IsNullOrWhiteSpace(gameId) && !string.IsNullOrWhiteSpace(password))
            await hubConnection.InvokeAsync("LoadGame", gameId, password);
    }

    public bool IsConnected => hubConnection.State == HubConnectionState.Connected;
        
    public void Dispose()
    {
        _ = hubConnection.DisposeAsync();
    }

    public bool DisableStartButton => CurrentGame.Players.Count < 2;

    private void AddTopic()
    {
        Topics.Add(Topic);
        Topic = "";
    }
    private void RemoveTopic(string topic)
    {
        Topics.Remove(topic);
    }
    
    private async void StartGame()
    {
        await hubConnection.InvokeAsync("StartGame", Topics);
    }
    
    private async void StartRound()
    {
        await hubConnection.InvokeAsync("StartRound", CurrentGame.Id);
    }

    private async void DeleteGame()
    {
        await hubConnection.InvokeAsync("DeleteGame", CurrentGame.Id, CurrentGame.Password);
    }


}
